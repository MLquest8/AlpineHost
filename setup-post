#!/bin/sh

#Readers
#pacRead='zathura zathura-cb zathura-pdf-mupdf zathura-djvu zathura-ps'

#Root
pacRoot='efibootmgr refind intel-ucode networkmanager sudo btop'

#Xorg
pacXorg='xorg xorg-xinit xorg-server xorg-xrandr xwallpaper'

#Video
pacVideo='xf86-video-intel libva-intel-driver libva-utils'

#Audio
pacAudio='pulseaudio pulseaudio-alsa alsa-utils'

#Internet
pacNet='firefox chromium qbittorrent yt-dlp'

#Fonts
pacFonts='ttf-font-awesome ttf-dejavu'

#Tray
pacTray='gxkb network-manager-applet'

#Input
pacInput='xf86-input-synaptics'

#Terminal
pacTerm='zsh zsh-completions'

#Files
pacFile='ranger p7zip'

#Passwords
pacPass='keepassxc'

#Media
pacMedia='sxiv mpv'

#Code
pacCode='code gdb'

echo "====================================================="
echo "Set up essentials: timezones, locale, network, etc..."
echo "====================================================="

# Set the time zone and generate /etc/adjtime
ln -sf /usr/share/zoneinfo/Asia/Tbilisi /etc/localtime
hwclock --systohc

# Generate locale
sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
locale-gen

# Set the LANG variable
echo "LANG=en_US.UTF-8" > /etc/locale.conf

# Create the hostname file: 
read -p "Enter hostname for the machine: " hostname
echo "$hostname" > /etc/hostname

echo "127.0.0.1	localhost" >> /etc/hosts
echo "::1       localhost" >> /etc/hosts
echo "127.0.1.1	$hostname" >> /etc/hosts

echo "====================================================="
echo "Installing packages from the official repositories..."
echo "====================================================="

# Install everything
pacman -S $pacRoot $pacXorg $pacVideo $pacAudio $pacNet $pacFonts $pacTray $pacInput $pacTerm $pacFile $pacPass $pacMedia $pacCode

# Install rEFInd into /efi
refind-install
echo "timeout 7" >> /boot/efi/EFI/refind/refind.conf

# Activate systemd services
systemctl enable systemd-timesyncd
systemctl enable systemd-resolved
systemctl enable NetworkManager

echo "====================================================="
echo "Packages installed. Compiling the rest from source..."
echo "====================================================="

# Compile executables
mkdir executables
cd executables

	# DWM
	git clone https://github.com/vipolar/dwm.git && cd dwm
	git checkout dailyarcher
	make install
	cd ..

	# DMENU
	git clone https://github.com/vipolar/dmenu.git && cd dmenu
	git checkout dailyarcher
	make install
	cd ..

	# ST
	git clone https://github.com/vipolar/st.git && cd st
	git checkout dailyarcher
	make install
	cd ..

	# Ponymix
	git clone https://github.com/falconindy/ponymix.git && cd ponymix
	make install
	cd ..

	# Tulizu
	git clone https://github.com/loh-tar/tulizu.git && cd tulizu
	make install
	tulizu install arch-rson451.issue
	cd ..

# Back to main directory
cd ..

echo "====================================================="
echo "Sources compiled. Adding user and editing dotfiles..."
echo "====================================================="

# Add a user and give them privileges
read -p "Enter username for the new user: " username
useradd -m -g users -G wheel,video,audio,input -s /bin/zsh $username
echo "$username ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/$username
chmod 0440 /etc/sudoers.d/$username
passwd $username

# Find homedir of the new user
homedir=$(awk -F: -v v="$username" '{if ($1==v) print $6}' /etc/passwd)

# Install and configure OhMyZsh
fgGreen='%{$fg[green]%}'
fgCyan='%{$fg[cyan]%}'
fgReset='%{$reset_color%}'
retStatus='${ret_status}'
gitInfo='$(git_prompt_info)'
su -l $username -c 'sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended'
echo "# export PROMPT='${fgGreen}%n@%m${fgReset} ${retStatus} ${fgCyan}%c${fgReset} ${gitInfo}'" >> $homedir/.zshrc
sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="bira"/' $homedir/.zshrc
sed -i 's/plugins=(git)/plugins=(git sudo)/' $homedir/.zshrc

# Update font cache
fc-cache -fv

# Copy X configs
cp -a -f ConfigX/. /etc/X11/xorg.conf.d/

# Copy and link dotfiles
mkdir -p $homedir/.config/
cp -a -f Config/. $homedir/.config/
ln -sf $homedir/.config/.* $homedir/
chown -R $username:users $homedir/.config/

# Copy user scripts to PATH
cp -a -f Scripts/. /usr/local/bin

# set up Quad9 dns
echo -e '[global-dns-domain-*]\nservers=9.9.9.9\n' > /etc/NetworkManager/conf.d/dns-servers.conf

echo "====================================================="
echo "Installing and configuring rEFInd dark theme (git)..." 
echo "====================================================="

# Clone refind-theme-regular
git clone https://github.com/bobafetthotmail/refind-theme-regular.git && cd refind-theme-regular
mkdir -p /boot/efi/EFI/refind/themes/regular/
cp src/theme.conf theme.conf
theme_path="_dark"
theme_name="dark"
size_small="48"
size_big="128"

# Edit theme.conf
sed -i "s/#big_icon_size $size_big/big_icon_size $size_big/" theme.conf
sed -i "s/#small_icon_size $size_small/small_icon_size $size_small/" theme.conf
sed -i "s/#icons_dir themes\/refind-theme-regular\/icons\/$size_big-$size_small/icons_dir themes\/refind-theme-regular\/icons\/$size_big-$size_small/" theme.conf
sed -i "s/#banner themes\/refind-theme-regular\/icons\/$size_big-$size_small\/bg$theme_path.png/banner themes\/refind-theme-regular\/icons\/$size_big-$size_small\/bg$theme_path.png/" theme.conf
sed -i "s/#selection_big themes\/refind-theme-regular\/icons\/$size_big-$size_small\/selection$theme_path-big.png/selection_big themes\/refind-theme-regular\/icons\/$size_big-$size_small\/selection$theme_path-big.png/" theme.conf
sed -i "s/#selection_small themes\/refind-theme-regular\/icons\/$size_big-$size_small\/selection$theme_path-small.png/selection_small themes\/refind-theme-regular\/icons\/$size_big-$size_small\/selection$theme_path-small.png/" theme.conf

# Finalize
echo "include themes/regular/theme.conf" >> /boot/efi/EFI/refind/refind.conf
cp -r fonts icons theme.conf /boot/efi/EFI/refind/themes/regular/
cd ..

echo "====================================================="
echo "Installation finished successfully! Press ENTER to..."
echo "====================================================="
read && reboot
